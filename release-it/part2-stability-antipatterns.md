# Release It! - Part 2: Stability Anti-Patterns

> Common patterns that CAUSE failures in production systems

---

## 1. Integration Points

### Concept
Every integration point (database, API, cache, queue) is a potential failure point. The more integrations, the higher the risk.

### The Problem
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              YOUR SERVICE'S ATTACK SURFACE                  â”‚
â”‚                                                             â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚ Your Service â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                           â”‚                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚     â”‚                     â”‚                     â”‚          â”‚
â”‚     â–¼                     â–¼                     â–¼          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ â”‚Databaseâ”‚          â”‚ Payment  â”‚          â”‚ Email   â”‚      â”‚
â”‚ â”‚        â”‚          â”‚ Gateway  â”‚          â”‚ Service â”‚      â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚     âš ï¸                   âš ï¸                    âš ï¸           â”‚
â”‚  Can fail            Can fail              Can fail        â”‚
â”‚  Can be slow         Can timeout           Can be down     â”‚
â”‚  Can corrupt         Can reject            Can lose msgs   â”‚
â”‚                                                             â”‚
â”‚         EACH IS A POTENTIAL SOURCE OF FAILURE              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Failure Modes at Integration Points
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           INTEGRATION POINT FAILURE MODES                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. CONNECTION FAILURES                                     â”‚
â”‚     â”œâ”€â”€ Connection refused                                  â”‚
â”‚     â”œâ”€â”€ Network unreachable                                 â”‚
â”‚     â””â”€â”€ DNS resolution failure                              â”‚
â”‚                                                             â”‚
â”‚  2. TIMEOUT FAILURES                                        â”‚
â”‚     â”œâ”€â”€ Connection timeout                                  â”‚
â”‚     â”œâ”€â”€ Read timeout                                        â”‚
â”‚     â””â”€â”€ Write timeout                                       â”‚
â”‚                                                             â”‚
â”‚  3. PROTOCOL ERRORS                                         â”‚
â”‚     â”œâ”€â”€ Unexpected response format                          â”‚
â”‚     â”œâ”€â”€ Version mismatch                                    â”‚
â”‚     â””â”€â”€ Invalid data encoding                               â”‚
â”‚                                                             â”‚
â”‚  4. SEMANTIC ERRORS                                         â”‚
â”‚     â”œâ”€â”€ Invalid response data                               â”‚
â”‚     â”œâ”€â”€ Partial success/failure                             â”‚
â”‚     â””â”€â”€ Out-of-order messages                               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Defense Strategy
```python
# BAD: Naive integration
def get_user_profile(user_id):
    response = requests.get(f"{USER_SERVICE}/users/{user_id}")
    return response.json()  # Can fail in many ways!

# GOOD: Defensive integration
def get_user_profile(user_id):
    try:
        response = requests.get(
            f"{USER_SERVICE}/users/{user_id}",
            timeout=(3, 10),  # connection, read timeouts
            headers={"Accept": "application/json"}
        )
        response.raise_for_status()
        
        data = response.json()
        return validate_user_schema(data)
        
    except requests.ConnectionError:
        logger.error("User service unreachable")
        return get_cached_profile(user_id)
    except requests.Timeout:
        logger.error("User service timeout")
        return get_cached_profile(user_id)
    except requests.HTTPError as e:
        logger.error(f"User service error: {e}")
        if e.response.status_code == 404:
            return None
        raise
```

---

## 2. Chain Reactions

### Concept
Failure in one component causes failures in others, creating a domino effect that brings down the entire system.

### The Domino Effect
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CHAIN REACTION                           â”‚
â”‚                                                             â”‚
â”‚  Step 1: One node fails                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ âœ“  â”‚  â”‚ âœ“  â”‚  â”‚ âœ—  â”‚  â”‚ âœ“  â”‚  â”‚ âœ“  â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜                    â”‚
â”‚                     â”‚                                       â”‚
â”‚                     â–¼                                       â”‚
â”‚  Step 2: Load shifts to remaining nodes                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ â–ˆâ–ˆ â”‚  â”‚ â–ˆâ–ˆ â”‚         â”‚ â–ˆâ–ˆ â”‚  â”‚ â–ˆâ–ˆ â”‚   â† Overloaded     â”‚
â”‚  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜                     â”‚
â”‚     â”‚       â”‚               â”‚       â”‚                       â”‚
â”‚     â–¼       â–¼               â–¼       â–¼                       â”‚
â”‚  Step 3: Overloaded nodes start failing                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ âœ—  â”‚  â”‚ âœ—  â”‚         â”‚ âœ“  â”‚  â”‚ âœ“  â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜                     â”‚
â”‚                             â”‚       â”‚                       â”‚
â”‚                             â–¼       â–¼                       â”‚
â”‚  Step 4: Complete system failure                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ âœ—  â”‚  â”‚ âœ—  â”‚         â”‚ âœ—  â”‚  â”‚ âœ—  â”‚   â† ALL DEAD      â”‚
â”‚  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Real-World Example
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               E-COMMERCE CHAIN REACTION                     â”‚
â”‚                                                             â”‚
â”‚  1. Slow database query on Product Service                  â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â–¼                                        â”‚
â”‚  2. Product Service threads blocked waiting                 â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â–¼                                        â”‚
â”‚  3. Product Service connection pool exhausted               â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â–¼                                        â”‚
â”‚  4. Cart Service waiting on Product Service                 â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â–¼                                        â”‚
â”‚  5. Cart Service threads blocked                            â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â–¼                                        â”‚
â”‚  6. Web tier waiting on Cart Service                        â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â–¼                                        â”‚
â”‚  7. ALL WEB REQUESTS TIMEOUT â†’ SITE DOWN                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Prevention: Defense in Depth
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             BREAKING THE CHAIN                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  Layer 1: BULKHEADS                                        â”‚
â”‚  â”œâ”€â”€ Isolate thread pools per service                      â”‚
â”‚  â””â”€â”€ Failure in Service A doesn't affect Service B         â”‚
â”‚                                                            â”‚
â”‚  Layer 2: CIRCUIT BREAKERS                                 â”‚
â”‚  â”œâ”€â”€ Stop calling failing services                         â”‚
â”‚  â””â”€â”€ Prevent cascading timeouts                            â”‚
â”‚                                                            â”‚
â”‚  Layer 3: TIMEOUTS                                         â”‚
â”‚  â”œâ”€â”€ Limit how long to wait                                â”‚
â”‚  â””â”€â”€ Free up threads faster                                â”‚
â”‚                                                            â”‚
â”‚  Layer 4: LOAD SHEDDING                                    â”‚
â”‚  â”œâ”€â”€ Reject excess traffic                                 â”‚
â”‚  â””â”€â”€ Protect healthy instances                             â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Cascading Failures

### Concept
A failure in one layer triggers failures in dependent layers, causing widespread outage.

### Diagram
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CASCADING FAILURE                         â”‚
â”‚                                                             â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚        â”‚         Load Balancer           â”‚                 â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                        â”‚                                    â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚        â–¼               â–¼               â–¼                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚ Web 1   â”‚    â”‚ Web 2   â”‚    â”‚ Web 3   â”‚  â† Layer 1    â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â”‚
â”‚        â”‚              â”‚              â”‚                     â”‚
â”‚        â–¼              â–¼              â–¼                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚           Service Layer                  â”‚  â† Layer 2  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                      â”‚                                     â”‚
â”‚                      â–¼                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚         Database (OVERLOADED)           â”‚  â† FAILURE  â”‚
â”‚   â”‚              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ               â”‚   ORIGIN    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                      â”‚                                     â”‚
â”‚   DB overload â†’ Service timeouts â†’ Web timeouts            â”‚
â”‚                      â”‚                                     â”‚
â”‚                      â–¼                                     â”‚
â”‚              COMPLETE SYSTEM FAILURE                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Common Cascade Triggers

| Trigger | How It Cascades |
|---------|-----------------|
| **Database lock** | Queries queue up â†’ Connection pool exhausted â†’ Service fails |
| **Memory leak** | GC pauses â†’ Slow responses â†’ Caller timeouts â†’ Retries â†’ More load |
| **Network partition** | Split brain â†’ Data inconsistency â†’ Application errors |
| **DNS failure** | All services can't resolve â†’ Everything fails |
| **Certificate expiry** | TLS handshake fails â†’ All HTTPS connections fail |

### Cascade Breaker Pattern
```java
public class CascadeProtection {
    private final CircuitBreaker circuitBreaker;
    private final RateLimiter rateLimiter;
    private final Bulkhead bulkhead;
    
    public Response processRequest(Request request) {
        // Layer 1: Rate limit (prevent overload)
        if (!rateLimiter.tryAcquire()) {
            return Response.tooManyRequests();
        }
        
        // Layer 2: Bulkhead (isolate resources)
        return bulkhead.executeSupplier(() -> {
            
            // Layer 3: Circuit breaker (stop cascades)
            return circuitBreaker.executeSupplier(() -> {
                return callDownstreamService(request);
            });
        });
    }
}
```

---

## 4. Users

### Concept
Users can be the source of system failures through unexpected behavior, malicious actions, or simply overwhelming traffic.

### User-Induced Failure Modes
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                USER FAILURE MODES                           â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚               TRAFFIC SPIKES                        â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚   Normal      Flash Sale       System Crash        â”‚    â”‚
â”‚  â”‚     â”‚            â–ˆâ–ˆâ–ˆâ–ˆ              â”‚                â”‚    â”‚
â”‚  â”‚     â”‚            â–ˆâ–ˆâ–ˆâ–ˆ              â”‚                â”‚    â”‚
â”‚  â”‚     â”‚            â–ˆâ–ˆâ–ˆâ–ˆ              â–¼                â”‚    â”‚
â”‚  â”‚    â”€â”¼â”€          â”€â”¼â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚    â”‚
â”‚  â”‚     â”‚            â”‚                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              REFRESH STORMS                         â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  Page slow â†’ User refreshes â†’ More load â†’ Slower   â”‚    â”‚
â”‚  â”‚       â†‘                                      â”‚      â”‚    â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â”‚              DEATH SPIRAL                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              EXPENSIVE OPERATIONS                   â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  "Download all my data" â†’ SELECT * with no limit   â”‚    â”‚
â”‚  â”‚  "Search everything" â†’ Full table scan             â”‚    â”‚
â”‚  â”‚  "Export report" â†’ 10GB response                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Types of Problematic Users
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               USER CATEGORIES                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ğŸ¤– BOTS & SCRAPERS                                        â”‚
â”‚     â€¢ Crawl entire site rapidly                            â”‚
â”‚     â€¢ Don't respect rate limits                            â”‚
â”‚     â€¢ Consume resources without value                      â”‚
â”‚                                                             â”‚
â”‚  ğŸ˜ˆ MALICIOUS USERS                                        â”‚
â”‚     â€¢ DDoS attacks                                         â”‚
â”‚     â€¢ Credential stuffing                                  â”‚
â”‚     â€¢ API abuse                                            â”‚
â”‚                                                             â”‚
â”‚  ğŸ˜ HEAVY USERS                                            â”‚
â”‚     â€¢ Power users with huge data                           â”‚
â”‚     â€¢ API integrations with high volume                    â”‚
â”‚     â€¢ Batch operations at peak times                       â”‚
â”‚                                                             â”‚
â”‚  ğŸ˜µ CONFUSED USERS                                         â”‚
â”‚     â€¢ Rapid clicking when page is slow                     â”‚
â”‚     â€¢ Opening many tabs                                    â”‚
â”‚     â€¢ Retrying failed operations repeatedly               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Protection Strategies
```python
# Rate limiting per user
@rate_limit(requests=100, window=60)  # 100 req/min
def api_endpoint(user_id, request):
    pass

# Request validation
def search_endpoint(query, limit=100, offset=0):
    MAX_LIMIT = 1000
    MAX_OFFSET = 10000
    
    # Prevent expensive queries
    if limit > MAX_LIMIT:
        limit = MAX_LIMIT
    if offset > MAX_OFFSET:
        raise BadRequest("Offset too large, use cursor pagination")
    
    return search(query, limit, offset)

# Expensive operation protection
@require_background_job  # Don't run synchronously
@max_execution_time(300)  # 5 minute limit
def export_all_data(user_id):
    pass
```

---

## 5. Blocked Threads

### Concept
Threads waiting on I/O, locks, or other resources can't process other requests, eventually exhausting all available threads.

### The Problem
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 THREAD POOL EXHAUSTION                      â”‚
â”‚                                                             â”‚
â”‚  Thread Pool (10 threads)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  Thread 1: [â–ˆâ–ˆâ–ˆâ–ˆ BLOCKED waiting for DB â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] â”‚    â”‚
â”‚  â”‚  Thread 2: [â–ˆâ–ˆâ–ˆâ–ˆ BLOCKED waiting for DB â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] â”‚    â”‚
â”‚  â”‚  Thread 3: [â–ˆâ–ˆâ–ˆâ–ˆ BLOCKED waiting for API â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] â”‚    â”‚
â”‚  â”‚  Thread 4: [â–ˆâ–ˆâ–ˆâ–ˆ BLOCKED waiting for lock â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] â”‚    â”‚
â”‚  â”‚  Thread 5: [â–ˆâ–ˆâ–ˆâ–ˆ BLOCKED waiting for DB â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] â”‚    â”‚
â”‚  â”‚  Thread 6: [â–ˆâ–ˆâ–ˆâ–ˆ BLOCKED waiting for API â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] â”‚    â”‚
â”‚  â”‚  Thread 7: [â–ˆâ–ˆâ–ˆâ–ˆ BLOCKED waiting for DB â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] â”‚    â”‚
â”‚  â”‚  Thread 8: [â–ˆâ–ˆâ–ˆâ–ˆ BLOCKED waiting for file â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] â”‚    â”‚
â”‚  â”‚  Thread 9: [â–ˆâ–ˆâ–ˆâ–ˆ BLOCKED waiting for DB â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] â”‚    â”‚
â”‚  â”‚  Thread 10:[â–ˆâ–ˆâ–ˆâ–ˆ BLOCKED waiting for API â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  New Request â”€â”€â–º NO THREADS AVAILABLE â”€â”€â–º REJECTED âŒ      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Common Blocking Causes
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              THREAD BLOCKING CAUSES                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  DATABASE                                                   â”‚
â”‚  â”œâ”€â”€ Slow queries                                          â”‚
â”‚  â”œâ”€â”€ Lock contention                                       â”‚
â”‚  â”œâ”€â”€ Connection pool wait                                  â”‚
â”‚  â””â”€â”€ Network issues to DB                                  â”‚
â”‚                                                             â”‚
â”‚  EXTERNAL SERVICES                                          â”‚
â”‚  â”œâ”€â”€ No timeout configured                                 â”‚
â”‚  â”œâ”€â”€ Service is slow/down                                  â”‚
â”‚  â””â”€â”€ DNS resolution hanging                                â”‚
â”‚                                                             â”‚
â”‚  SYNCHRONIZATION                                            â”‚
â”‚  â”œâ”€â”€ Mutex/lock contention                                 â”‚
â”‚  â”œâ”€â”€ Synchronized blocks                                   â”‚
â”‚  â””â”€â”€ Deadlocks                                             â”‚
â”‚                                                             â”‚
â”‚  FILE I/O                                                   â”‚
â”‚  â”œâ”€â”€ NFS mount issues                                      â”‚
â”‚  â”œâ”€â”€ Disk full                                             â”‚
â”‚  â””â”€â”€ Large file operations                                 â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Solutions
```java
// BAD: Blocking call without timeout
public Data fetchData() {
    return externalService.getData();  // Can block forever!
}

// GOOD: Non-blocking with timeout
public CompletableFuture<Data> fetchDataAsync() {
    return CompletableFuture.supplyAsync(() -> {
        return externalService.getData();
    }, executor).orTimeout(5, TimeUnit.SECONDS);
}

// GOOD: With timeout wrapper
public Data fetchData() {
    ExecutorService executor = Executors.newSingleThreadExecutor();
    Future<Data> future = executor.submit(() -> externalService.getData());
    
    try {
        return future.get(5, TimeUnit.SECONDS);
    } catch (TimeoutException e) {
        future.cancel(true);
        throw new ServiceTimeoutException("External service timeout");
    }
}
```

---

## 6. Self-Denial Attacks

### Concept
Your own system or marketing creates traffic that overwhelms your infrastructure.

### Examples
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                SELF-DENIAL SCENARIOS                        â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚            MARKETING EMAIL BLAST                    â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  "50% OFF SALE!"                                   â”‚    â”‚
â”‚  â”‚       â”‚                                            â”‚    â”‚
â”‚  â”‚       â”‚ Sent to 5 million users                    â”‚    â”‚
â”‚  â”‚       â”‚ at 9:00 AM                                 â”‚    â”‚
â”‚  â”‚       â–¼                                            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚    â”‚
â”‚  â”‚  â”‚  Traffic spike at 9:01  â”‚                       â”‚    â”‚
â”‚  â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚ 100x normal          â”‚    â”‚
â”‚  â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚                       â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚    â”‚
â”‚  â”‚       â”‚                                            â”‚    â”‚
â”‚  â”‚       â–¼                                            â”‚    â”‚
â”‚  â”‚    SITE CRASHES                                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚            CRON JOB STAMPEDE                        â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  Server 1: cron job at 00:00:00                    â”‚    â”‚
â”‚  â”‚  Server 2: cron job at 00:00:00                    â”‚    â”‚
â”‚  â”‚  Server 3: cron job at 00:00:00  â†’  ALL HIT DB    â”‚    â”‚
â”‚  â”‚  Server 4: cron job at 00:00:00      AT ONCE      â”‚    â”‚
â”‚  â”‚  Server 5: cron job at 00:00:00                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚            CACHE STAMPEDE                           â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  Cache expires â†’ 1000 requests â†’ All hit DB        â”‚    â”‚
â”‚  â”‚                   simultaneously                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Prevention Strategies
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SELF-DENIAL PREVENTION                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  FOR MARKETING EVENTS:                                      â”‚
â”‚  â€¢ Stagger email sending over hours                        â”‚
â”‚  â€¢ Use waiting room / queue system                         â”‚
â”‚  â€¢ Pre-scale infrastructure                                â”‚
â”‚  â€¢ Disable non-essential features                          â”‚
â”‚                                                             â”‚
â”‚  FOR CRON JOBS:                                            â”‚
â”‚  â€¢ Add random jitter to start times                        â”‚
â”‚  â€¢ Use distributed job scheduling                          â”‚
â”‚  â€¢ Spread jobs across time windows                         â”‚
â”‚                                                             â”‚
â”‚  FOR CACHE:                                                â”‚
â”‚  â€¢ Use cache stampede protection (locking)                 â”‚
â”‚  â€¢ Stagger cache expiration times                          â”‚
â”‚  â€¢ Background refresh before expiry                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cache Stampede Protection
```python
import threading
import time

class StampedeProtectedCache:
    def __init__(self):
        self.cache = {}
        self.locks = {}
    
    def get(self, key, fetch_func, ttl=300):
        # Check cache first
        if key in self.cache:
            value, expiry = self.cache[key]
            if time.time() < expiry:
                return value
        
        # Only one thread fetches, others wait
        if key not in self.locks:
            self.locks[key] = threading.Lock()
        
        with self.locks[key]:
            # Double-check after acquiring lock
            if key in self.cache:
                value, expiry = self.cache[key]
                if time.time() < expiry:
                    return value
            
            # Fetch and cache
            value = fetch_func()
            self.cache[key] = (value, time.time() + ttl)
            return value
```

---

## 7. Scaling Effects

### Concept
Patterns that work at small scale can fail catastrophically at large scale.

### Examples
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 SCALING PROBLEMS                            â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         POINT-TO-POINT CONNECTIONS                  â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  3 services = 3 connections                        â”‚    â”‚
â”‚  â”‚     A â”€â”€â”€â”€ B                                       â”‚    â”‚
â”‚  â”‚     â”‚ \  / â”‚                                       â”‚    â”‚
â”‚  â”‚     â”‚  \/  â”‚                                       â”‚    â”‚
â”‚  â”‚     â”‚  /\  â”‚                                       â”‚    â”‚
â”‚  â”‚     â”‚ /  \ â”‚                                       â”‚    â”‚
â”‚  â”‚     C â”€â”€â”€â”€ D                                       â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  10 services = 45 connections                      â”‚    â”‚
â”‚  â”‚  100 services = 4,950 connections                  â”‚    â”‚
â”‚  â”‚  1000 services = 499,500 connections  â† PROBLEM!  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚            O(nÂ²) OPERATIONS                         â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  "Compare all users for duplicates"                â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  1,000 users   = 1,000,000 comparisons     (OK)   â”‚    â”‚
â”‚  â”‚  10,000 users  = 100,000,000 comparisons   (slow) â”‚    â”‚
â”‚  â”‚  100,000 users = 10,000,000,000 comparisons (ğŸ’€)  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚          SHARED RESOURCE CONTENTION                 â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  1 server  â†’ 1 lock contention                     â”‚    â”‚
â”‚  â”‚  10 servers â†’ 10x lock contention                  â”‚    â”‚
â”‚  â”‚  100 servers â†’ Lock becomes bottleneck             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Solutions
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SCALING SOLUTIONS                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  Point-to-Point â†’ Message Queue / Service Mesh             â”‚
â”‚  â”Œâ”€â”€â”€â”    â”Œâ”€â”€â”€â”         â”Œâ”€â”€â”€â”                             â”‚
â”‚  â”‚ A â”‚ â”€â–º â”‚ Q â”‚ â—„â”€â”€â”€    â”‚ A â”‚                             â”‚
â”‚  â””â”€â”€â”€â”˜    â”‚ u â”‚    â”‚    â””â”€â”¬â”€â”˜                             â”‚
â”‚  â”Œâ”€â”€â”€â”    â”‚ e â”‚    â”‚      â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ B â”‚ â”€â–º â”‚ u â”‚ â—„â”€â”€â”¼â”€â”€    â””â”€â”€â–º â”‚ Service â”‚ â—„â”€â”€ B         â”‚
â”‚  â””â”€â”€â”€â”˜    â”‚ e â”‚    â”‚          â”‚  Mesh   â”‚ â—„â”€â”€ C         â”‚
â”‚  â”Œâ”€â”€â”€â”    â””â”€â”€â”€â”˜    â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚  â”‚ C â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚  â””â”€â”€â”€â”˜                                                     â”‚
â”‚                                                            â”‚
â”‚  O(nÂ²) â†’ O(n log n) or O(n)                               â”‚
â”‚  â€¢ Use proper data structures (hash sets, B-trees)        â”‚
â”‚  â€¢ Pre-compute results                                     â”‚
â”‚  â€¢ Use probabilistic algorithms (bloom filters)           â”‚
â”‚                                                            â”‚
â”‚  Shared Resource â†’ Partition / Shard                       â”‚
â”‚  â€¢ Shard databases by tenant/region                       â”‚
â”‚  â€¢ Use distributed locks with partition                   â”‚
â”‚  â€¢ Replicate read-only resources                          â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Unbalanced Capacities

### Concept
When different parts of your system can handle different amounts of load, the weakest link fails first and brings everything down.

### The Problem
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              UNBALANCED CAPACITY                            â”‚
â”‚                                                             â”‚
â”‚   Frontend Capacity: 100,000 requests/sec                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                 â”‚
â”‚                           â–¼                                 â”‚
â”‚   API Capacity: 50,000 requests/sec                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚   â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚                           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                           â”‚                                 â”‚
â”‚                           â–¼                                 â”‚
â”‚   Database Capacity: 10,000 requests/sec                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚   â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚ â† BOTTLENECK!                               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                             â”‚
â”‚   Result: Frontend at 15% â†’ API at 30% â†’ DB at 100%        â”‚
â”‚           Everything else is blocked waiting for DB         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Solutions
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             BALANCING STRATEGIES                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. BACKPRESSURE                                           â”‚
â”‚     â€¢ Upstream services slow down when downstream is full  â”‚
â”‚     â€¢ Use bounded queues that reject when full             â”‚
â”‚                                                             â”‚
â”‚  2. LOAD SHEDDING                                          â”‚
â”‚     â€¢ Reject requests before hitting bottleneck            â”‚
â”‚     â€¢ Return 503 instead of queueing                       â”‚
â”‚                                                             â”‚
â”‚  3. RATE LIMITING                                          â”‚
â”‚     â€¢ Limit at the frontend to match backend capacity      â”‚
â”‚     â€¢ Per-user and global limits                           â”‚
â”‚                                                             â”‚
â”‚  4. SCALING THE BOTTLENECK                                 â”‚
â”‚     â€¢ Add read replicas for database                       â”‚
â”‚     â€¢ Shard heavy tables                                   â”‚
â”‚     â€¢ Add caching layer                                    â”‚
â”‚                                                             â”‚
â”‚  5. ASYNC PROCESSING                                       â”‚
â”‚     â€¢ Queue writes for later processing                    â”‚
â”‚     â€¢ Return "accepted" immediately                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Example: Backpressure with Bounded Queue
```java
// Producer with backpressure
BlockingQueue<Task> queue = new ArrayBlockingQueue<>(1000);

public void submitTask(Task task) {
    boolean accepted = queue.offer(task, 100, TimeUnit.MILLISECONDS);
    if (!accepted) {
        throw new ServiceOverloadedException("System busy, try later");
    }
}

// Consumer processes at its own pace
public void processLoop() {
    while (true) {
        Task task = queue.take();  // Blocks if empty
        process(task);
    }
}
```

---

## Summary: Anti-Pattern Recognition

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ANTI-PATTERN QUICK REFERENCE                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Anti-Pattern          â”‚ Symptoms                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Integration Points    â”‚ Errors from external calls         â”‚
â”‚ Chain Reactions       â”‚ Failures spreading between nodes   â”‚
â”‚ Cascading Failures    â”‚ Layers failing in sequence         â”‚
â”‚ Users                 â”‚ Traffic spikes, abuse patterns     â”‚
â”‚ Blocked Threads       â”‚ Thread pool exhaustion             â”‚
â”‚ Self-Denial           â”‚ Internal traffic overwhelming sys  â”‚
â”‚ Scaling Effects       â”‚ Works small, fails large           â”‚
â”‚ Unbalanced Capacity   â”‚ Bottleneck at one component       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Takeaways

1. **Every integration is a risk** - Protect every external call
2. **Failures cascade** - Design to contain, not spread failures
3. **Users are unpredictable** - Protect against both malicious and accidental abuse
4. **Test at scale** - What works with 10 users may fail with 10,000
5. **Balance capacities** - Your system is only as strong as its weakest component
